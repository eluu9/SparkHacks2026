{% extends "base.html" %}

{% block content %}
<div class="auth-flex-center">
    <div class="login-card pop-animation">

        <div class="text-center mb-4">
            <h3 class="fw-bold text-dark ls-tight">Welcome Back</h3>
            <p class="text-muted small">Sign in to sync your wardrobe and kits</p>
        </div>

        <button id="google-signin-trigger" class="btn btn-outline-dark w-100 pill-btn">
            Sign in with Google
        </button>

        <div class="position-relative mb-4">
            <hr class="text-muted opacity-25">
            <span class="position-absolute top-50 start-50 translate-middle bg-white px-3 text-muted"
                  style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px;">
                Secure Access
            </span>
        </div>

        <div class="text-center">
            <p class="small text-muted mb-0">
                New to the lab?
                <a href="{{ url_for('auth.signup_page') }}" class="text-dark fw-bold text-decoration-none">
                    Create Account
                </a>
            </p>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCrDraVHDBhnQNFMq4JkqNffCQuA4O9FpI",
        authDomain: "sparkhacks-b2985.firebaseapp.com",
        projectId: "sparkhacks-b2985",
        storageBucket: "sparkhacks-b2985.firebasestorage.app",
        messagingSenderId: "399492923349",
        appId: "1:399492923349:web:be15e8843340026c70075c",
        measurementId: "G-09JS9YQS93",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById("google-signin-trigger");

    if (loginBtn) {
        loginBtn.addEventListener("click", async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                const idToken = await result.user.getIdToken();

                // Exchange the Firebase token for a Flask session
                const response = await fetch("/auth/session-login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ idToken }),
                });

                const data = await response.json();
                if (data.status === "success") {
                    window.location.href = "/dashboard";
                } else {
                    alert("Auth failed: " + data.error);
                }
            } catch (error) {
                console.error("Firebase Error:", error.code);
                alert("Firebase Error: " + error.message);
            }
        });
    } else {
        console.error("Login button 'google-signin-trigger' not found in DOM.");
    }
</script>
{% endblock %}