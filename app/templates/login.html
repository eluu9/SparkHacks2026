{% extends "base.html" %}

{% block content %}
<style>
    .auth-flex-center {
        min-height: calc(100vh - 60px);
        display: flex; align-items: center; justify-content: center;
    }
    .login-card {
        background: #fff; padding: 2rem; border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.02);
        width: 90%; max-width: 400px;
    }
</style>

<div class="auth-flex-center">
    <div class="login-card text-center">
        <h2 class="fw-bold mb-4">Log in to KARTWISE.AI</h2>
        
        <button id="google-signin-btn" class="btn btn-outline-dark w-100 pill-btn mb-3">
            <i class="bi bi-google me-2"></i> Continue with Google
        </button>

        <div class="text-muted small my-3">- OR -</div>

        <div class="text-start">
            <div class="mb-3">
                <label class="form-label small text-muted">Email</label>
                <input type="email" id="email" class="form-control pill-input" placeholder="name@example.com">
            </div>
            <div class="mb-4">
                <label class="form-label small text-muted">Password</label>
                <input type="password" id="password" class="form-control pill-input" placeholder="••••••••">
            </div>
            
            <div class="d-grid gap-2">
                <button id="email-login-btn" class="btn btn-primary pill-btn">Login</button>
                <button id="email-signup-btn" class="btn btn-link text-muted btn-sm">Create Account</button>
            </div>
        </div>
        
        <p id="error-msg" class="text-danger mt-3 small"></p>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { 
        getAuth, 
        signInWithPopup, 
        GoogleAuthProvider, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword 
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    const firebaseConfig = {
  apiKey: "AIzaSyCrDraVHDBhnQNFMq4JkqNffCQuA4O9FpI",
  authDomain: "sparkhacks-b2985.firebaseapp.com",
  projectId: "sparkhacks-b2985",
  storageBucket: "sparkhacks-b2985.firebasestorage.app",
  messagingSenderId: "399492923349",
  appId: "1:399492923349:web:be15e8843340026c70075c",
  measurementId: "G-09JS9YQS93"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    document.getElementById('google-signin-btn').addEventListener('click', async () => {
        try {
            const result = await signInWithPopup(auth, provider);
            handleAuthResult(result.user);
        } catch (error) { showError(error.message); }
    });


    document.getElementById('email-login-btn').addEventListener('click', async () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        try {
            const result = await signInWithEmailAndPassword(auth, email, pass);
            handleAuthResult(result.user);
        } catch (error) { showError("Login Failed: " + error.code); }
    });

    document.getElementById('email-signup-btn').addEventListener('click', async () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        if(pass.length < 6) { showError("Password must be at least 6 characters."); return; }

        try {
            const result = await createUserWithEmailAndPassword(auth, email, pass);
            handleAuthResult(result.user);
        } catch (error) { showError("Signup Failed: " + error.message); }
    });

    async function handleAuthResult(user) {
        const idToken = await user.getIdToken();
        const response = await fetch('/auth/session-login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ idToken: idToken })
        });
        const data = await response.json();
        if (data.status === 'success') { window.location.href = '/'; } 
        else { showError(data.error); }
    }

    function showError(msg) { document.getElementById('error-msg').innerText = msg; }
</script>
{% endblock %}