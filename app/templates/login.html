{% extends "base.html" %}

{% block content %}
<div class="auth-flex-center"> <div class="login-card pop-animation">
        
        <div class="text-center mb-4">
            <h3 class="fw-bold text-dark ls-tight">Welcome Back</h3>
            <p class="text-muted small">Sign in to sync your wardrobe and kits</p>
        </div>

        <button id="google-signin-trigger" class="btn btn-outline-dark w-100 pill-btn...">
            Sign in with Google
        </button>

        <div class="position-relative mb-4">
            <hr class="text-muted opacity-25">
            <span class="position-absolute top-50 start-50 translate-middle bg-white px-3 text-muted" style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px;">
                Secure Access
            </span>
        </div>

        <div class="text-center">
            <p class="small text-muted mb-0">
                New to the lab? <a href="{{ url_for('auth.signup_page') }}" class="text-dark fw-bold text-decoration-none">Create Account</a>
            </p>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    import { getAuth, signInWithRedirect, getRedirectResult, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

const auth = getAuth();
const provider = new GoogleAuthProvider();

// 1. Check if we are returning from a redirect
getRedirectResult(auth)
    .then(async (result) => {
        if (result) {
            console.log("Redirect successful, syncing session...");
            const idToken = await result.user.getIdToken();
            await syncSession(idToken); // Helper function (see below)
        }
    })
    .catch((error) => {
        console.error("Redirect Auth Error:", error);
    });

// 2. Button Click triggers Redirect instead of Popup
const loginBtn = document.getElementById('google-signin-trigger');
if (loginBtn) {
    loginBtn.addEventListener('click', () => {
        console.log("Starting redirect login...");
        signInWithRedirect(auth, provider);
    });
}

// 3. The Sync Logic (Extract this to reuse)
async function syncSession(idToken) {
    try {
        const response = await fetch('/auth/session-login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ idToken: idToken })
        });
        
        const data = await response.json();
        if (data.status === 'success') {
            window.location.href = '/';
        } else {
            alert("Backend session failed: " + data.error);
        }
    } catch (e) {
        console.error("Sync error:", e);
    }
}
</script>
{% endblock %}