{% extends "base.html" %}

{% block content %}
<div class="auth-container">
    <div class="auth-card chat-bubble-anim">
        <div class="text-center mb-4">
            <h3 class="fw-bold text-dark">Join the Lab</h3>
            <p class="text-muted small">Create an account to start building kits</p>
        </div>

        <form id="signup-form">
            <div class="mb-3">
                <label class="form-label small fw-bold text-uppercase ls-1">Email Address</label>
                <input type="email" id="signup-email" class="form-control form-control-pill" placeholder="name@uic.edu" required>
            </div>
            <div class="mb-4">
                <label class="form-label small fw-bold text-uppercase ls-1">Password</label>
                <input type="password" id="signup-password" class="form-control form-control-pill" placeholder="Min. 6 characters" required>
            </div>
            <button type="submit" class="btn btn-dark w-100 btn-pill mb-3">Create Account</button>
        </form>

        <div id="error-message" class="text-danger small text-center mb-3" style="display:none;"></div>

        <p class="text-center small text-muted">
            Already have an account? <a href="/auth/login" class="text-dark fw-bold text-decoration-none">Sign in</a>
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    // Using your existing Firebase Config
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyCrDraVHDBhnQNFMq4JkqNffCQuA4O9FpI",
        authDomain: "sparkhacks-b2985.firebaseapp.com",
        projectId: "sparkhacks-b2985",
        storageBucket: "sparkhacks-b2985.firebasestorage.app",
        messagingSenderId: "399492923349",
        appId: "1:399492923349:web:be15e8843340026c70075c",
        measurementId: "G-09JS9YQS93"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();

    const signupForm = document.getElementById('signup-form');
    const errorDiv = document.getElementById('error-message');

    signupForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;

        createUserWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                // Get the ID Token to create a session in Flask
                return userCredential.user.getIdToken();
            })
            .then((idToken) => {
                // Send to your session-login endpoint just like the login page
                return fetch('/auth/session-login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ idToken: idToken })
                });
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    window.location.href = '/'; // Redirect to main chat
                }
            })
            .catch((error) => {
                errorDiv.innerText = error.message;
                errorDiv.style.display = 'block';
            });
    });
</script>
{% endblock %}