{% extends "base.html" %}

{% block content %}
<div class="auth-flex-center">
    <div class="login-card pop-animation">
        
        <div class="text-center mb-4">
            <h3 class="fw-bold text-dark ls-tight">Join the Lab</h3>
            <p class="text-muted small">Create an account to start building kits</p>
        </div>

        <form id="lab-signup-form">
            <div class="mb-3">
                <label class="form-label smallest fw-bold text-uppercase ls-1">Email Address</label>
                <input type="email" id="email-field" class="form-control pill-input" placeholder="name@uic.edu" required>
            </div>
            
            <div class="mb-4">
                <label class="form-label smallest fw-bold text-uppercase ls-1">Password</label>
                <input type="password" id="password-field" class="form-control pill-input" placeholder="Min. 6 characters" required>
            </div>

            <button type="submit" class="btn btn-dark w-100 pill-btn mb-3">
                Create Account <i class="bi bi-arrow-right ms-1"></i>
            </button>
        </form>

        <div id="status-msg" class="text-danger smallest text-center mb-3" style="display:none;"></div>

        <div class="mt-4 pt-2 border-top text-center">
            <p class="small text-muted mb-0">
                Already have an account? <a href="/auth/login" class="text-dark fw-bold text-decoration-none">Sign in</a>
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
    // Firebase setup
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyCrDraVHDBhnQNFMq4JkqNffCQuA4O9FpI",
        authDomain: "sparkhacks-b2985.firebaseapp.com",
        projectId: "sparkhacks-b2985",
        storageBucket: "sparkhacks-b2985.firebasestorage.app",
        messagingSenderId: "399492923349",
        appId: "1:399492923349:web:be15e8843340026c70075c",
        measurementId: "G-09JS9YQS93"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();

    const form = document.getElementById('lab-signup-form');
    const statusBox = document.getElementById('status-msg');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Clear previous errors
        statusBox.style.display = 'none';
        
        const email = document.getElementById('email-field').value;
        const password = document.getElementById('password-field').value;

        try {
            console.log("Registering new user...");
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            
            // Handshake with Flask backend
            const idToken = await userCredential.user.getIdToken();
            
            const response = await fetch('/auth/session-login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ idToken: idToken })
            });

            const data = await response.json();

            if (data.status === 'success') {
                window.location.href = '/dashboard'; // Redirect to the authenticated space
            }else {
                throw new Error(data.error || "Backend session failed");
            }

        } catch (error) {
            console.error("Signup Error:", error.code, error.message);
            
            // Human-readable error messages
            let msg = "Signup failed. Check your connection.";
            if (error.code === 'auth/email-already-in-use') msg = "This email is already registered.";
            if (error.code === 'auth/weak-password') msg = "Password is too weak. Try adding symbols.";
            
            statusBox.innerText = msg;
            statusBox.style.display = 'block';
        }
    });
</script>
{% endblock %}